appId: app.mygrid.grid
---

# PART 1: Fresh Start and Login
- launchApp
- waitForAnimationToEnd

# If we see welcome screen, complete onboarding
- tapOn: 
    text: "Get Started"
    optional: true
- waitForAnimationToEnd
- tapOn:
    text: "Continue"
    optional: true
- waitForAnimationToEnd

# Login with local server
- tapOn:
    text: "Custom Provider"
    optional: true
- waitForAnimationToEnd
- inputText: "localhost:8008"
- tapOn: "Continue"
- waitForAnimationToEnd

# Enter credentials
- inputText: "testuser1"
- tapOn: "Next"
- waitForAnimationToEnd
- inputText: "testpass123"  
- tapOn: "Sign In"
- waitForAnimationToEnd

# Should reach map
- assertVisible: "Map"

# PART 2: Add Friend Lifecycle
- tapOn: "Add Contact"
- waitForAnimationToEnd
- inputText: "testuser2"
- tapOn: "Send Request"
- waitForAnimationToEnd

# Close modal
- tapOn: "Cancel"
- assertVisible: "Map"

# PART 3: Receive and Accept Friend Request via API
- runScript:
    script: |
      cd .maestro/helpers
      ./api_login.sh testuser3 testpass123
      ./api_send_friend_request.sh testuser3 testuser1

# Wait for friend request
- waitForAnimationToEnd

# Check notifications
- tapOn: "Notifications"
- waitForAnimationToEnd

# Accept friend request
- assertVisible: "testuser3"
- tapOn: "Accept"
- waitForAnimationToEnd

# Return to map
- tapOn: "Back"
- assertVisible: "Map"

# PART 4: Create Group
- tapOn: "Create Group"
- waitForAnimationToEnd

# Enter group name
- inputText: "RegressionTestGroup"
- tapOn: "Next"
- waitForAnimationToEnd

# Select friend to invite
- tapOn: "testuser3"
- tapOn: "Create"
- waitForAnimationToEnd

# Should return to map
- assertVisible: "Map"

# PART 5: Receive Group Invite and Accept
- runScript:
    script: |
      cd .maestro/helpers
      ./api_login.sh testuser4 testpass123
      ./api_create_group.sh testuser4 "InviteTestGroup" 7200
      ./api_join_room.sh testuser1 "InviteTestGroup"

# Wait for group invite
- waitForAnimationToEnd

# Check notifications for group invite
- tapOn: "Notifications"
- waitForAnimationToEnd

# Should see group invite
- assertVisible: "InviteTestGroup"
- tapOn: "Accept"
- waitForAnimationToEnd

# Return to map
- tapOn: "Back"
- assertVisible: "Map"

# PART 6: Location Sharing and Verification
- runScript:
    script: |
      cd .maestro/helpers
      # Multiple friends send locations
      ./api_send_location.sh testuser3 40.7580 -73.9855
      ./api_send_location.sh testuser4 40.7590 -73.9865

# Wait for locations to appear
- waitForAnimationToEnd

# Verify markers on map
- assertVisible: "testuser3"
- assertVisible: "testuser4"

# Test map interaction
- tapOn:
    point: "50%,50%"
- delay: 1000

# PART 7: Verify Groups Tab
- tapOn: "Groups"
- waitForAnimationToEnd

# Should see both groups
- assertVisible: "RegressionTestGroup"
- assertVisible: "InviteTestGroup"

# Check group details
- tapOn: "RegressionTestGroup"
- waitForAnimationToEnd
- assertVisible: "Members"
- assertVisible: "testuser3"

# Return to map
- tapOn: "Map"
- assertVisible: "Map"

# PART 8: Change Display Name
- tapOn: "Settings"
- assertVisible: "Display Name"

- tapOn: "Display Name"
- waitForAnimationToEnd
- clearText
- inputText: "RegressionTestUser"
- tapOn: "Save"
- waitForAnimationToEnd

# Verify change
- tapOn: "Back"
- assertVisible: "RegressionTestUser"

# PART 9: Toggle Incognito Mode
- scrollUntilVisible:
    element: "Incognito Mode"
    direction: DOWN

- tapOn: "Incognito Mode"
- waitForAnimationToEnd

# Should show incognito is enabled
- assertVisible:
    text: "ON"
    optional: true

# Return to map
- tapOn: "Back"
- assertVisible: "Map"

# Should see incognito indicator
- assertVisible:
    text: "incognito"
    optional: true

# PART 10: Test Group Activity in Incognito
- runScript:
    script: |
      cd .maestro/helpers
      ./api_send_location.sh testuser3 40.7585 -73.9860
      ./api_send_location.sh testuser4 40.7595 -73.9870

# Should still receive locations in incognito
- waitForAnimationToEnd
- assertVisible: "testuser3"
- assertVisible: "testuser4"

# PART 11: Sign Out
- tapOn: "Settings"
- waitForAnimationToEnd

- scrollUntilVisible:
    element: "Sign Out"
    direction: DOWN

- tapOn: "Sign Out"
- waitForAnimationToEnd

# Confirm sign out
- tapOn: "Sign Out"
- waitForAnimationToEnd

# Should return to welcome screen
- assertVisible: "Welcome to Grid"

# PART 12: Sign Back In
- tapOn: "Get Started"
- waitForAnimationToEnd

- tapOn: "Custom Provider"
- waitForAnimationToEnd
- inputText: "localhost:8008"
- tapOn: "Continue"
- waitForAnimationToEnd

- inputText: "testuser1"
- tapOn: "Next"
- waitForAnimationToEnd
- inputText: "testpass123"
- tapOn: "Sign In"
- waitForAnimationToEnd

# PART 13: Verify State After Re-login
- assertVisible: "Map"

# Settings should be preserved
- tapOn: "Settings"
- assertVisible: "RegressionTestUser"

# Incognito should be preserved
- scrollUntilVisible:
    element: "Incognito Mode"
    direction: DOWN
- assertVisible:
    text: "ON"
    optional: true

# Return to map
- tapOn: "Back"
- assertVisible: "Map"

# Friends should still be there
- assertVisible: "testuser3"
- assertVisible: "testuser4"

# Groups should still exist
- tapOn: "Groups"
- assertVisible: "RegressionTestGroup"
- assertVisible: "InviteTestGroup"

# Return to map for final verification
- tapOn: "Map"
- assertVisible: "Map"

# PART 14: Final Comprehensive Verification
# Test that everything still works after full cycle

# Send new locations
- runScript:
    script: |
      cd .maestro/helpers
      ./api_send_location.sh testuser3 40.7600 -73.9880
      ./api_send_location.sh testuser4 40.7610 -73.9890

# Should receive new locations
- waitForAnimationToEnd
- assertVisible: "testuser3"
- assertVisible: "testuser4"

# Test final navigation
- tapOn: "Settings"
- assertVisible: "RegressionTestUser"
- tapOn: "Back"

- tapOn: "Groups"
- assertVisible: "RegressionTestGroup"
- tapOn: "Map"

# SUCCESS: Full regression journey completed
- assertVisible: "Map"
- assertVisible: "testuser3"
- assertVisible: "testuser4"