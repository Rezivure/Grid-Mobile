appId: app.mygrid.grid
env:
  MAESTRO_DIR: .maestro
---
# Test: Complete group lifecycle with multiple members and location sharing
# Maestro creates group "Road Trip" → API joins as testuser2 and testuser3 → location sharing → member leaves
# Prerequisites: testuser1 logged in on map screen, local Synapse server running

- launchApp
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 1: Tap the person-add icon to open Add Friend / Create Group modal
- tapOn:
    point: "60%,62%"
- waitForAnimationToEnd

# Step 2: Wait for modal, then switch to Create Group tab
- extendedWaitUntil:
    visible: "Add Contact"
    timeout: 5000
- tapOn: "Create Group"
- waitForAnimationToEnd

# Step 3: Enter group name
- tapOn: "Group Name"
- inputText: "Road Trip"
- waitForAnimationToEnd
- hideKeyboard
- waitForAnimationToEnd

# Step 4: Advance to duration selection
- tapOn: "Next"
- waitForAnimationToEnd

# Step 5: Select 24h duration
- tapOn: "24h"
- waitForAnimationToEnd

# Step 6: Advance to member selection
- tapOn: "Next"
- waitForAnimationToEnd

# Step 7: Add testuser2 as member
- tapOn: "Username"
- inputText: "testuser2"
- waitForAnimationToEnd
- tapOn: "Add Member"
- waitForAnimationToEnd

# Step 8: Add testuser3 as member
- tapOn: "Username"
- inputText: "testuser3"
- waitForAnimationToEnd
- tapOn: "Add Member"
- waitForAnimationToEnd

# Step 9: Advance to summary
- tapOn: "Next"
- waitForAnimationToEnd

# Step 10: Create the group
- tapOn: "Create Group"
- waitForAnimationToEnd

# Step 11: Verify returned to map screen
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 15000

# Step 12: Get the group room ID (most recently created room for testuser1)
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"
- runScript:
    file: scripts/api_get_latest_room.js
    env:
      USER: testuser1
      MAESTRO_DIR: ${MAESTRO_DIR}

# Step 13: API users join the group
- runScript:
    file: scripts/api_join_room.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/api_join_room.js
    env:
      USER: testuser3
      ROOM_ID: ${output.roomId}
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"   # Give sync time

# Step 14: Pull to refresh
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "2000"

# Step 15: Check Groups tab to verify group created
- tapOn:
    point: "85%,62%"  # Groups tab
- waitForAnimationToEnd
- assertVisible: "Road Trip"

# Step 16: Tap on Road Trip group to see members
- tapOn: "Road Trip"
- waitForAnimationToEnd
- assertVisible: "testuser2"
- assertVisible: "testuser3"

# Step 17: Go back to map
- tapOn:
    point: "20%,10%"  # Back button
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 18: API sends location from testuser2 (Washington DC)
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "38.9072"
      LON: "-77.0369"
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 19: API sends location from testuser3 (NYC)
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser3
      ROOM_ID: ${output.roomId}
      LAT: "40.7128"
      LON: "-74.0060"
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 20: Verify both markers appear on map
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000
- extendedWaitUntil:
    visible:
      text: "testuser3"
    timeout: 15000

# Step 21: testuser3 leaves the group via API
- runScript:
    file: scripts/api_leave_room.js
    env:
      USER: testuser3
      ROOM_ID: ${output.roomId}
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 22: Pull to refresh
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"

# Step 23: Check group member count decreased
- tapOn:
    point: "85%,62%"  # Groups tab
- waitForAnimationToEnd
- tapOn: "Road Trip"
- waitForAnimationToEnd
- assertVisible: "2"  # Updated member count

# Step 24: Go back to map
- tapOn:
    point: "20%,10%"  # Back button
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 25: testuser2 sends another location to verify still works
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "38.8951"
      LON: "-77.0364"
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 26: Verify testuser2 still visible
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000
