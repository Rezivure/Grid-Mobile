appId: app.mygrid.grid
---
# Test: Complete group lifecycle with multiple members and location sharing
# Maestro creates group "Road Trip" → API joins as testuser2 and testuser3 → all 3 members visible → location sharing → member leaves → marker gone
# Prerequisites: testuser1 logged in on map screen, local Synapse server running

- launchApp
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 1: Tap the person-add icon to open Add Friend / Create Group modal
- tapOn:
    point: "60%,62%"
- waitForAnimationToEnd

# Step 2: Switch to Create Group tab
- tapOn: "Create Group"
- waitForAnimationToEnd

# Step 3: Enter group name
- tapOn: "Group Name"
- inputText: "Road Trip"
- waitForAnimationToEnd
- hideKeyboard
- waitForAnimationToEnd

# Step 4: Advance to duration selection
- tapOn: "Next"
- waitForAnimationToEnd

# Step 5: Select 24h duration
- tapOn: "24h"
- waitForAnimationToEnd

# Step 6: Advance to member selection
- tapOn: "Next"
- waitForAnimationToEnd

# Step 7: Add testuser2 as member
- tapOn: "Username"
- inputText: "testuser2"
- waitForAnimationToEnd
- tapOn: "Add Member"
- waitForAnimationToEnd

# Step 8: Add testuser3 as member  
- tapOn: "Username"
- inputText: "testuser3"
- waitForAnimationToEnd
- tapOn: "Add Member"
- waitForAnimationToEnd

# Step 9: Advance to summary
- tapOn: "Next"
- waitForAnimationToEnd

# Step 10: Create the group
- tapOn: "Create Group"
- waitForAnimationToEnd

# Step 11: Verify returned to map screen
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 15000

# Step 12: API users join the group
- wait: 3000
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser1)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Road Trip|!.*road.*trip"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_join_room.sh testuser2 "$ROOM_ID" && ./api_join_room.sh testuser3 "$ROOM_ID"; echo "Joined room: $ROOM_ID"; fi
- waitForAnimationToEnd
- wait: 5000  # Give sync time

# Step 13: Pull to refresh to sync group updates
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- wait: 2000

# Step 14: Check Groups tab to verify group created and members joined
- tapOn:
    point: "85%,62%"  # Groups tab
- waitForAnimationToEnd

# Should see "Road Trip" group
- assertVisible: "Road Trip"

# Step 15: Tap on Road Trip group to see members
- tapOn: "Road Trip"
- waitForAnimationToEnd

# Should see 3 members total (testuser1, testuser2, testuser3)
- assertVisible: "testuser2"
- assertVisible: "testuser3"

# Step 16: Go back to map
- tapOn:
    point: "20%,10%"  # Back button
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 17: API sends location from testuser2 (Washington DC)
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser2)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Road Trip|!.*road.*trip"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser2 "$ROOM_ID" 38.9072 -77.0369; fi
- wait: 5000  # Allow time for sync

# Step 18: API sends location from testuser3 (NYC)  
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser3)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Road Trip|!.*road.*trip"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser3 "$ROOM_ID" 40.7128 -74.0060; fi
- wait: 5000  # Allow time for sync

# Step 19: Verify both markers appear on map
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000

- extendedWaitUntil:
    visible:
      text: "testuser3"
    timeout: 15000

# Step 20: Test tapping on one of the markers
- tapOn:
    text: "testuser2"
- waitForAnimationToEnd

# Check if profile appears, then close it
- runFlow:
    when:
      visible: "testuser2"
    commands:
      - wait: 2000
      - tapOn:
          point: "70%,30%"  # Close profile
      - waitForAnimationToEnd

# Step 21: Verify group member count in groups tab
- tapOn:
    point: "85%,62%"  # Groups tab
- waitForAnimationToEnd
- tapOn: "Road Trip"
- waitForAnimationToEnd

# Count should show 3 members
- assertVisible: "3"  # Member count

# Go back to map
- tapOn:
    point: "20%,10%"  # Back button
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 22: testuser3 leaves the group via API
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser3)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Road Trip|!.*road.*trip"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_leave_room.sh testuser3 "$ROOM_ID"; fi
- wait: 5000  # Give sync time for leave

# Step 23: Pull to refresh to sync the leave
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- wait: 3000

# Step 24: Verify testuser3's marker is gone/stale
- runFlow:
    when:
      visible:
        text: "testuser3"
    commands:
      # If still visible, it might be stale location - this is app-dependent behavior
      - wait: 2000

# Step 25: Check group member count decreased
- tapOn:
    point: "85%,62%"  # Groups tab
- waitForAnimationToEnd
- tapOn: "Road Trip" 
- waitForAnimationToEnd

# Should now show 2 members (testuser1 and testuser2)
- assertVisible: "2"  # Updated member count

# Verify testuser3 is no longer in member list
- runFlow:
    when:
      visible:
        text: "testuser3"
    commands:
      - assertVisible: "This should not be visible - testuser3 left"

# Step 26: Verify testuser2 still visible and can send locations
- tapOn:
    point: "20%,10%"  # Back button
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# testuser2 sends another location
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser2)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Road Trip|!.*road.*trip"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser2 "$ROOM_ID" 38.8951 -77.0364; fi
- wait: 5000

# Step 27: Verify testuser2 still visible after group member left
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000

# Final state: Group lifecycle completed - created, members joined, locations shared, member left, count updated