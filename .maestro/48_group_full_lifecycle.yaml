appId: app.mygrid.grid
---
# Test: Complete group lifecycle with multiple members and location sharing
# Prerequisites: testuser1 logged in on map screen, local Synapse server running

- launchApp
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 1: Tap person-add icon
- tapOn:
    point: "60%,62%"
- waitForAnimationToEnd

# Step 2: Switch to Create Group tab (coordinate tap - Flutter accessibility)
- tapOn:
    point: "73%,8%"
- waitForAnimationToEnd

# Step 3: Enter group name
- tapOn: "Group Name"
- inputText: "Road Trip"
- waitForAnimationToEnd
- hideKeyboard
- waitForAnimationToEnd

# Step 4: Advance to duration
- tapOn: "Next"
- waitForAnimationToEnd

# Step 5: Select 24h duration
- tapOn: "24h"
- waitForAnimationToEnd

# Step 6: Advance to members
- tapOn: "Next"
- waitForAnimationToEnd

# Step 7: Add testuser2
- tapOn: "Username"
- inputText: "testuser2"
- waitForAnimationToEnd
- tapOn: "Add Member"
- waitForAnimationToEnd

# Step 8: Add testuser3
- tapOn: "Username"
- inputText: "testuser3"
- waitForAnimationToEnd
- tapOn: "Add Member"
- waitForAnimationToEnd

# Step 9: Advance to summary
- tapOn: "Next"
- waitForAnimationToEnd

# Step 10: Create the group
- tapOn: "Create Group"
- waitForAnimationToEnd

# Step 11: Verify returned to map
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 15000

# Step 12: Get the group room ID
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"
- runScript:
    file: scripts/api_get_latest_room.js
    env:
      USER: testuser1

# Step 13: API users join the group
- runScript:
    file: scripts/api_join_room.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
- runScript:
    file: scripts/api_join_room.js
    env:
      USER: testuser3
      ROOM_ID: ${output.roomId}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 14: Pull to refresh
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "2000"

# Step 15: Check Groups tab
- tapOn:
    point: "85%,62%"
- waitForAnimationToEnd
- assertVisible: "Road Trip"

# Step 16: Tap Road Trip to see members
- tapOn: "Road Trip"
- waitForAnimationToEnd
- assertVisible: "testuser2"
- assertVisible: "testuser3"

# Step 17: Go back to map
- tapOn:
    point: "20%,10%"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 18: API sends location from testuser2
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "38.9072"
      LON: "-77.0369"
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 19: API sends location from testuser3
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser3
      ROOM_ID: ${output.roomId}
      LAT: "40.7128"
      LON: "-74.0060"
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 20: Verify markers
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000
- extendedWaitUntil:
    visible:
      text: "testuser3"
    timeout: 15000

# Step 21: testuser3 leaves
- runScript:
    file: scripts/api_leave_room.js
    env:
      USER: testuser3
      ROOM_ID: ${output.roomId}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 22: Pull to refresh
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"

# Step 23: Check group member count
- tapOn:
    point: "85%,62%"
- waitForAnimationToEnd
- tapOn: "Road Trip"
- waitForAnimationToEnd
- assertVisible: "2"

# Step 24: Go back to map
- tapOn:
    point: "20%,10%"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 25: testuser2 sends another location
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "38.8951"
      LON: "-77.0364"
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 26: Verify testuser2 still visible
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000
