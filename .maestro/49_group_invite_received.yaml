appId: app.mygrid.grid
---
# Test: Receive group invite and accept with location sharing
# API creates group "Beach Day" and invites testuser1 → Maestro accepts → API sends locations for 2 members → verify markers
# Prerequisites: testuser1 logged in on map screen, local Synapse server running

- launchApp
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 1: API creates group "Beach Day" with testuser5 as creator and invites testuser1
- runScript:
    script: cd .maestro/helpers && ./api_create_group.sh testuser5 "Beach Day" testuser1
- waitForAnimationToEnd
- wait: 5000  # Give sync time for group creation and invite

# Step 2: Pull to refresh to sync new group invite
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- wait: 3000

# Step 3: Tap notification bell to see group invite
- tapOn:
    point: "90%,62%"
- waitForAnimationToEnd

# Step 4: Verify notification modal opened
- assertVisible: "Notifications"

# Should see group invitation (may show group name or creator)
- assertVisible:
    textRegex: "(Beach Day|testuser5|group)"

# Step 5: Accept the group invite  
- tapOn:
    point: "50%,28%"  # First invite card
- waitForAnimationToEnd
- tapOn: "Accept Request"  # Or "Join Group" depending on UI
- waitForAnimationToEnd

# Step 6: Close notifications modal
- tapOn: "Close"
- waitForAnimationToEnd

# Step 7: Verify back on map screen
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 15000

# Step 8: Verify group appears in Groups tab
- tapOn:
    point: "85%,62%"  # Groups tab  
- waitForAnimationToEnd

# Should see "Beach Day" group
- assertVisible: "Beach Day"

# Step 9: Tap on Beach Day group to see members
- tapOn: "Beach Day"
- waitForAnimationToEnd

# Should see testuser5 (creator) and testuser1 (self)
- assertVisible: "testuser5"

# Check member count shows 2
- assertVisible: "2"

# Step 10: Go back to map
- tapOn:
    point: "20%,10%"  # Back button
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 11: API has testuser5 join the group (creator auto-joins)
- wait: 2000
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser5)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Beach Day|!.*beach.*day"))' | head -1) && echo "Room ID: $ROOM_ID"
- waitForAnimationToEnd

# Step 12: Add testuser6 to the group via API
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser5)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Beach Day|!.*beach.*day"))' | head -1) && if [ -n "$ROOM_ID" ]; then curl -s -X POST "http://localhost:8008/_matrix/client/r0/rooms/$ROOM_ID/invite" -H "Authorization: Bearer $(./api_login.sh testuser5)" -H "Content-Type: application/json" -d "{\"user_id\":\"@testuser6:localhost\"}" && ./api_join_room.sh testuser6 "$ROOM_ID"; fi
- wait: 5000  # Give sync time

# Step 13: Pull to refresh to sync new member
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- wait: 2000

# Step 14: API sends location from testuser5 (Miami Beach)
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser5)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Beach Day|!.*beach.*day"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser5 "$ROOM_ID" 25.7907 -80.1300; fi
- wait: 5000  # Allow time for sync

# Step 15: API sends location from testuser6 (Santa Monica)
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser6)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Beach Day|!.*beach.*day"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser6 "$ROOM_ID" 34.0194 -118.4912; fi
- wait: 5000  # Allow time for sync

# Step 16: Verify both location markers appear on map
- extendedWaitUntil:
    visible:
      text: "testuser5"
    timeout: 15000

- extendedWaitUntil:
    visible:
      text: "testuser6"  
    timeout: 15000

# Step 17: Test interaction with markers
- tapOn:
    text: "testuser5"
- waitForAnimationToEnd

# Check if profile/info appears
- runFlow:
    when:
      visible:
        text: "testuser5"
    commands:
      - wait: 2000
      # Close profile if it opened  
      - tapOn:
          point: "70%,30%"
      - waitForAnimationToEnd

# Step 18: Verify updated group member count  
- tapOn:
    point: "85%,62%"  # Groups tab
- waitForAnimationToEnd
- tapOn: "Beach Day"
- waitForAnimationToEnd

# Should now show 3 members (testuser1, testuser5, testuser6)
- assertVisible: "3"
- assertVisible: "testuser5"
- assertVisible: "testuser6"

# Step 19: Go back to map and test location updates
- tapOn:
    point: "20%,10%"  # Back button  
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 20: Send updated locations to test real-time updates
- wait: 2000
- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser5)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Beach Day|!.*beach.*day"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser5 "$ROOM_ID" 25.7823 -80.1277; fi
- wait: 4000

- runScript:
    script: cd .maestro/helpers && ROOM_ID=$(curl -s -H "Authorization: Bearer $(./api_login.sh testuser6)" "http://localhost:8008/_matrix/client/r0/joined_rooms" | jq -r '.joined_rooms[] | select(. | test("Beach Day|!.*beach.*day"))' | head -1) && if [ -n "$ROOM_ID" ]; then ./api_send_location.sh testuser6 "$ROOM_ID" 34.0259 -118.4994; fi
- wait: 4000

# Step 21: Verify markers still visible after location updates
- extendedWaitUntil:
    visible:
      text: "testuser5"
    timeout: 15000

- extendedWaitUntil:
    visible:
      text: "testuser6"
    timeout: 15000

# Step 22: Test searching within group members
- tapOn: "Search Contacts"
- waitForAnimationToEnd
- inputText: "testuser5"
- waitForAnimationToEnd

# Should show testuser5 in search
- assertVisible: "testuser5"

# Clear search
- tapOn: "Search Contacts"
- inputText: ""
- waitForAnimationToEnd
- hideKeyboard
- waitForAnimationToEnd

# Final state: Group invite successfully received, accepted, members joined, and multiple location markers displayed