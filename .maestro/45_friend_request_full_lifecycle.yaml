appId: app.mygrid.grid
env:
  MAESTRO_DIR: .maestro
---
# Test: Complete friend request lifecycle with location sharing
# API sends friend request from testuser2 → Maestro accepts → location sharing → movement → stop sharing
# Prerequisites: testuser1 logged in on map screen, local Synapse server running

- launchApp
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 1: API sends friend request from testuser2
- runScript:
    file: scripts/api_send_friend_request.js
    env:
      FROM_USER: testuser2
      TO_USER: testuser1
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"   # Give sync time

# Step 2: Pull to refresh to sync new invites
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "2000"

# Step 3: Tap notification bell to see friend request
- tapOn:
    point: "90%,62%"
- waitForAnimationToEnd

# Step 4: Verify notification modal opened and accept request
- assertVisible: "Notifications"
- tapOn:
    point: "50%,28%"  # First invite card
- waitForAnimationToEnd
- tapOn: "Accept Request"
- waitForAnimationToEnd

# Step 5: Close notifications modal
- tapOn: "Close"
- waitForAnimationToEnd

# Step 6: Verify back on map screen
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 15000

# Step 7: Get testuser2's room ID
- runScript:
    file: scripts/api_get_room.js
    env:
      USER: testuser2
      MAESTRO_DIR: ${MAESTRO_DIR}

# Step 8: API sends location from testuser2 (Times Square)
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "40.7580"
      LON: "-73.9855"
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"   # Allow time for Matrix sync and UI update

# Step 9: Verify testuser2's location marker appears on map
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000

# Step 10: API updates testuser2's location (moves to Central Park)
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "40.7829"
      LON: "-73.9654"
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 11: Verify marker still visible
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000

# Step 12: Verify friend appears in contacts list
- tapOn:
    point: "30%,62%"  # Contacts drawer
- waitForAnimationToEnd
- assertVisible: "testuser2"

# Step 13: Close contacts drawer
- tapOn:
    point: "70%,45%"  # Tap map area to close drawer
- waitForAnimationToEnd

# Step 14: Send another location to verify real-time updates
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "2000"
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "40.7614"
      LON: "-73.9776"
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 15: Final verification - location still visible
- extendedWaitUntil:
    visible:
      text: "testuser2"
    timeout: 15000

# Step 16: API user leaves the room (simulates stop sharing)
- runScript:
    file: scripts/api_leave_room.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      MAESTRO_DIR: ${MAESTRO_DIR}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 17: Verify back on map screen
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000
