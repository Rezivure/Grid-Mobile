appId: app.mygrid.grid
---
# Test: Complete friend request lifecycle with location sharing
# API sends friend request from testuser2 → Maestro accepts → location sharing via API
# Prerequisites: testuser1 logged in on map screen, local Synapse server running

- launchApp
- waitForAnimationToEnd
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000

# Step 1: API sends friend request from testuser2
- runScript:
    file: scripts/api_send_friend_request.js
    env:
      FROM_USER: testuser2
      TO_USER: testuser1
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"

# Step 2: Pull to refresh
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "2000"

# Step 3: Tap notification bell
- tapOn:
    point: "90%,62%"
- waitForAnimationToEnd

# Step 4: Accept friend request
- assertVisible: "Notifications"
- tapOn:
    point: "50%,28%"
- waitForAnimationToEnd
- tapOn: "Accept Request"
- waitForAnimationToEnd

# Step 5: Close notifications
- tapOn: "Close"
- waitForAnimationToEnd

# Step 6: Verify back on map
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 15000

# Step 7: Verify we're on map with contacts visible (friend accepted)
- assertVisible: "Search Contacts"

# Step 8: Get testuser2's room ID
- runScript:
    file: scripts/api_get_room.js
    env:
      USER: testuser2

# Step 9: API sends location from testuser2
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "40.7580"
      LON: "-73.9855"
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 10: Pull to refresh to pick up location
- swipe:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"

# Step 11: Verify still on map screen (location received)
- assertVisible: "My Contacts"

# Step 12: API updates location (Central Park)
- runScript:
    file: scripts/api_send_location.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
      LAT: "40.7829"
      LON: "-73.9654"
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "3000"

# Step 13: API user leaves the room (stop sharing)
- runScript:
    file: scripts/api_leave_room.js
    env:
      USER: testuser2
      ROOM_ID: ${output.roomId}
- runScript:
    file: scripts/sleep.js
    env:
      DURATION_MS: "5000"

# Step 14: Verify back on map screen
- extendedWaitUntil:
    visible: "My Contacts"
    timeout: 10000
